<!-- ‚úÖ Gesti√≥n de Reservas - AIR593 (Funcionalidad Mejorada) -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 dark:from-gray-900 dark:to-slate-900 transition-colors duration-300">
  
  <!-- Header Section -->
  <div class="relative bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 dark:from-blue-900 dark:via-indigo-900 dark:to-purple-900 overflow-hidden">
    <div class="absolute inset-0 opacity-10" 
         style="background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.3) 1px, transparent 0); background-size: 40px 40px;">
    </div>
    
    <div class="container px-6 py-12 mx-auto relative z-10">
      <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-black text-white leading-tight mb-4">
          Gesti√≥n de <span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-300">Reservas</span>
        </h1>
        <p class="text-lg text-white/80">
          {{ itemsCount }} item{{ itemsCount !== 1 ? 's' : '' }} en tu reserva
        </p>
      </div>
    </div>
    
    <div class="absolute bottom-0 left-0 right-0">
      <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-16 md:h-20">
        <path d="M0 32L60 29.3C120 27 240 21 360 18.7C480 16 600 16 720 18.7C840 21 960 27 1080 29.3C1200 32 1320 32 1380 32L1440 32V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0V32Z" fill="currentColor" class="text-slate-50 dark:text-gray-900"/>
      </svg>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container px-6 py-12 mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Left Column - Cart Items -->
      <div class="lg:col-span-2 space-y-4">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Mis Viajes Seleccionados
          </h2>
          
          <!-- Clear Cart Button -->
          @if (carrito.length > 0) {
            <button (click)="limpiarCarrito()" 
                    class="text-sm text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Limpiar todo
            </button>
          }
        </div>
        
        <!-- Cart Items -->
        @for (item of carrito; track item.id; let i = $index) {
          <div class="group p-5 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center gap-4 flex-1">
              <img [src]="item.imagen" [alt]="item.destino" class="w-20 h-20 rounded-xl object-cover shadow-md group-hover:scale-105 transition-transform duration-300">
              <div>
                <p class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{{ item.destino }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ item.categoria }}</p>
                <div class="flex items-center gap-1 mt-1">
                  @for (estrella of [].constructor(item.estrellas); track estrella) {
                    <span class="text-yellow-400 text-xs">‚≠ê</span>
                  }
                </div>
              </div>
            </div>
            
            <div class="text-right w-full sm:w-auto">
              <p class="text-2xl font-black text-blue-600 dark:text-blue-400 mb-2">${{ item.precio }}</p>
              <button (click)="eliminar(i)" 
                      class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm font-bold flex items-center gap-1 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Eliminar
              </button>
            </div>
          </div>
        }

        <!-- Empty State -->
        @if (carrito.length === 0) {
          <div class="text-center p-12 bg-white dark:bg-gray-800 rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-700">
            <svg class="w-20 h-20 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
            <p class="text-gray-500 dark:text-gray-400 text-lg font-medium mb-2">No tienes reservas pendientes</p>
            <p class="text-sm text-blue-500 dark:text-blue-400 mb-4">Explora nuestros destinos y crea tu viaje ideal</p>
            <a routerLink="/catalogo" class="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors shadow-lg hover:shadow-xl">
              Ir al Cat√°logo
            </a>
          </div>
        }
      </div>

      <!-- Right Column - Summary -->
      <div class="lg:col-span-1">
        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950 text-white p-8 rounded-3xl shadow-2xl sticky top-6">
          <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            Resumen
          </h2>
          
          <!-- Cart Items Summary -->
          <ul class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
            @for (item of carrito; track item.id) {
              <li class="flex justify-between text-gray-300 text-sm pb-3 border-b border-gray-700 last:border-0">
                <span class="truncate pr-2">{{ item.destino }}</span>
                <span class="font-bold text-white whitespace-nowrap">${{ item.precio }}</span>
              </li>
            }
          </ul>

          <!-- Price Breakdown -->
          <div class="space-y-3 mb-6 text-sm">
            <div class="flex justify-between text-gray-300">
              <span>Subtotal:</span>
              <span>${{ total }}</span>
            </div>
            @if (descuento > 0) {
              <div class="flex justify-between text-green-400 font-semibold">
                <span>Descuento (10%):</span>
                <span>-${{ descuento }}</span>
              </div>
            }
            <div class="flex justify-between text-lg font-bold border-t border-gray-700 pt-3">
              <span>Total:</span>
              <span class="text-2xl text-green-400">${{ totalConDescuento }}</span>
            </div>
          </div>

          <!-- Discount Badge -->
          @if (descuento > 0) {
            <div class="mb-6 p-3 bg-green-500/20 border border-green-500/30 rounded-xl text-center">
              <p class="text-green-300 text-sm font-medium">üéâ ¬°Descuento aplicado!</p>
              <p class="text-green-400 text-xs">Por compras mayores a $</p>
            </div>
          }
          
          <!-- Pay Button -->
          <button (click)="abrirCaja()" 
                  [disabled]="!puedePagar"
                  class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 disabled:from-gray-700 disabled:to-gray-800 disabled:cursor-not-allowed text-white font-black py-4 rounded-2xl text-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 active:scale-95 flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
            </svg>
            PAGAR AHORA
          </button>

          <!-- Security Badges -->
          <div class="mt-6 pt-6 border-t border-gray-700 text-center">
            <div class="flex items-center justify-center gap-4 text-xs text-gray-400">
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                Seguro
              </span>
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                Encriptado
              </span>
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Reembolso
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  @if (verPago) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 transition-opacity duration-300" (click)="cerrarCaja()">
      <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-3xl p-8 shadow-2xl relative animate-fade-in-down" (click)="$event.stopPropagation()">
        
        <!-- Close Button -->
        <button (click)="cerrarCaja()" 
                class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 text-gray-400 hover:text-gray-800 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        
        <!-- Success State -->
        @if (pagoExitoso) {
          <div class="text-center py-8">
            <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg class="w-10 h-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="text-2xl font-black text-gray-900 dark:text-white mb-2">¬°Pago Exitoso! üéâ</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-6">Tu reserva ha sido confirmada. Revisa tu correo para los detalles.</p>
            <div class="animate-pulse">
              <p class="text-sm text-blue-600 dark:text-blue-400">Redirigiendo...</p>
            </div>
          </div>
        }

        <!-- Payment Form -->
        @if (!pagoExitoso) {
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
              </svg>
            </div>
            <h2 class="text-2xl font-black text-gray-900 dark:text-white">Pago Seguro</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Completa tus datos para finalizar</p>
          </div>
          
          <!-- Error Message -->
          @if (mensajeError) {
            <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl flex items-start gap-3">
              <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p class="text-sm text-red-700 dark:text-red-300">{{ mensajeError }}</p>
            </div>
          }
          
          <form [formGroup]="formPago" (ngSubmit)="pagarTodo()" class="space-y-5">
            
            <!-- Email for Receipt -->
            <div>
              <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">Email para recibo</label>
              <input type="email" formControlName="email" placeholder="tu@email.com" 
                     class="w-full p-4 border border-gray-200 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-900 transition-all placeholder-gray-400"
                     [class.border-red-500]="formPago.get('email')?.invalid && formPago.get('email')?.touched">
              <p *ngIf="formPago.get('email')?.hasError('required') && formPago.get('email')?.touched" class="text-red-500 text-xs mt-1">
                El email es obligatorio
              </p>
              <p *ngIf="formPago.get('email')?.hasError('email') && formPago.get('email')?.touched" class="text-red-500 text-xs mt-1">
                Ingresa un email v√°lido
              </p>
            </div>

            <!-- Card Holder -->
            <div>
              <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">Titular de la tarjeta</label>
              <input type="text" formControlName="titular" placeholder="NOMBRE COMO APARECE EN TARJETA" 
                     class="w-full p-4 border border-gray-200 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-900 transition-all uppercase placeholder-gray-400"
                     [class.border-red-500]="formPago.get('titular')?.invalid && formPago.get('titular')?.touched">
              <p *ngIf="formPago.get('titular')?.hasError('required') && formPago.get('titular')?.touched" class="text-red-500 text-xs mt-1">
                Este campo es obligatorio
              </p>
            </div>

            <!-- Card Number -->
            <div>
              <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">N√∫mero de Tarjeta</label>
              <div class="relative">
                <input type="text" formControlName="tarjeta" placeholder="0000 0000 0000 0000" maxlength="19"
                       (input)="formatearTarjeta($event)"
                       class="w-full p-4 pl-12 border border-gray-200 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-900 transition-all font-mono text-lg tracking-wider"
                       [class.border-red-500]="formPago.get('tarjeta')?.invalid && formPago.get('tarjeta')?.touched">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                  <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
              </div>
              <p *ngIf="formPago.get('tarjeta')?.hasError('pattern') && formPago.get('tarjeta')?.touched" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Deben ser 16 d√≠gitos
              </p>
            </div>

            <!-- Expiry & CVV -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">Expiraci√≥n</label>
                <input type="text" formControlName="fecha" placeholder="MM/YY" maxlength="5"
                       (input)="formatearFecha($event)"
                       class="w-full p-4 border border-gray-200 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-900 transition-all text-center font-mono"
                       [class.border-red-500]="formPago.get('fecha')?.invalid && formPago.get('fecha')?.touched">
              </div>

              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">CVV</label>
                <input type="password" formControlName="cvv" placeholder="123" maxlength="3"
                       (input)="validarSoloNumeros($event)"
                       class="w-full p-4 border border-gray-200 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-900 transition-all text-center font-mono tracking-widest"
                       [class.border-red-500]="formPago.get('cvv')?.invalid && formPago.get('cvv')?.touched">
              </div>
            </div>

            <!-- Total -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-2xl border border-blue-100 dark:border-blue-800 flex justify-between items-center">
              <span class="text-blue-800 dark:text-blue-300 font-bold text-lg">Total a pagar:</span>
              <span class="text-3xl font-black text-blue-900 dark:text-blue-100">${{ totalConDescuento }}</span>
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                    [disabled]="formPago.invalid || procesandoPago"
                    class="w-full py-4 rounded-2xl text-xl font-black shadow-xl transition-all duration-300
                           text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 active:scale-95 hover:shadow-2xl
                           disabled:from-gray-300 disabled:to-gray-400 disabled:text-gray-500 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none flex items-center justify-center gap-2">
              
              <!-- Loading Spinner -->
              @if (procesandoPago) {
                <svg class="animate-spin w-6 h-6" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Procesando...</span>
              }
              
              <!-- Success Icon -->
              @if (!procesandoPago && formPago.valid) {
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>CONFIRMAR PAGO</span>
              }
              
              <!-- Default State -->
              @if (!procesandoPago && !formPago.valid) {
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <span>COMPLETA LOS DATOS</span>
              }
            </button>
          </form>
        }
      </div>
    </div>
  }
</div>